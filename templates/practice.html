{% extends "base.html" %}

{% block title %}Harjoittele - LOVe Enhanced{% endblock %}

{% block content %}
<!-- ============================================ -->
<!-- UUSI: VALINTANÄKYMÄ (setupScreen) -->
<!-- ============================================ -->
<div id="setupScreen" class="container py-5" style="display: none;">
    <div class="card shadow-lg mx-auto" style="max-width: 800px;">
        <div class="card-header bg-gradient text-white text-center py-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <h2 class="mb-0">
                <i class="fas fa-cog me-2"></i>Harjoitusasetukset
            </h2>
            <p class="mb-0 mt-2 opacity-75">Valitse kategoriat, vaikeustasot ja kysymysten määrä</p>
        </div>
        <div class="card-body p-4">
            <form id="practiceSetupForm">
                <!-- Kategoriat -->
                <div class="mb-4">
                    <label class="form-label fw-bold fs-5">
                        <i class="fas fa-list-ul text-primary me-2"></i>Kategoriat
                    </label>
                    <div class="alert alert-info py-2 mb-3">
                        <small><i class="fas fa-info-circle me-1"></i>Valitse vähintään yksi kategoria</small>
                    </div>
                    
                    {% if categories %}
                    <div class="row g-2" id="categoryCheckboxes">
                        {% for cat in categories %}
                        <div class="col-md-6">
                            <div class="form-check p-3 border rounded hover-shadow" style="transition: all 0.2s;">
                                <input class="form-check-input category-checkbox" type="checkbox" 
                                       name="categories" value="{{ cat.id }}" 
                                       id="cat{{ cat.id }}" checked>
                                <label class="form-check-label w-100 cursor-pointer" for="cat{{ cat.id }}">
                                    <strong>{{ cat.name }}</strong>
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="mt-2">
                        <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="selectAllCategories()">
                            <i class="fas fa-check-double me-1"></i>Valitse kaikki
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllCategories()">
                            <i class="fas fa-times me-1"></i>Poista valinnat
                        </button>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>Kategorioita ei saatavilla
                    </div>
                    {% endif %}
                </div>

                <!-- Vaikeustasot -->
                <div class="mb-4">
                    <label class="form-label fw-bold fs-5">
                        <i class="fas fa-layer-group text-warning me-2"></i>Vaikeustasot
                    </label>
                    <div class="alert alert-info py-2 mb-3">
                        <small><i class="fas fa-info-circle me-1"></i>Valitse vähintään yksi vaikeustaso</small>
                    </div>
                    
                    <div class="row g-2">
                        <div class="col-md-4">
                            <div class="form-check p-3 border rounded hover-shadow" style="transition: all 0.2s; border-color: #10b981 !important;">
                                <input class="form-check-input difficulty-checkbox" type="checkbox" 
                                       name="difficulties" value="easy" id="diffEasy" checked>
                                <label class="form-check-label w-100 cursor-pointer" for="diffEasy">
                                    <i class="fas fa-smile text-success me-2"></i>
                                    <strong>Helppo</strong>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check p-3 border rounded hover-shadow" style="transition: all 0.2s; border-color: #fbbf24 !important;">
                                <input class="form-check-input difficulty-checkbox" type="checkbox" 
                                       name="difficulties" value="medium" id="diffMedium" checked>
                                <label class="form-check-label w-100 cursor-pointer" for="diffMedium">
                                    <i class="fas fa-meh text-warning me-2"></i>
                                    <strong>Keskivaikea</strong>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check p-3 border rounded hover-shadow" style="transition: all 0.2s; border-color: #ef4444 !important;">
                                <input class="form-check-input difficulty-checkbox" type="checkbox" 
                                       name="difficulties" value="hard" id="diffHard" checked>
                                <label class="form-check-label w-100 cursor-pointer" for="diffHard">
                                    <i class="fas fa-frown text-danger me-2"></i>
                                    <strong>Vaikea</strong>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Kysymysten määrä -->
                <div class="mb-4">
                    <label for="questionCount" class="form-label fw-bold fs-5">
                        <i class="fas fa-hashtag text-info me-2"></i>Kysymysten määrä
                    </label>
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <input type="number" class="form-control form-control-lg" id="questionCount" 
                                   name="count" value="10" min="1" max="100">
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Voit valita 1-100 kysymystä
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Virheviestit -->
                <div id="setupError" class="alert alert-danger d-none">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span id="setupErrorMessage"></span>
                </div>

                <!-- Aloitusnappi -->
                <button type="submit" class="btn btn-primary btn-lg w-100 py-3">
                    <i class="fas fa-play me-2"></i>Aloita harjoittelu
                </button>
            </form>
            
            <!-- Takaisin-linkki -->
            <div class="text-center mt-4">
                <a href="{{ url_for('dashboard_route') }}" class="btn btn-link">
                    <i class="fas fa-arrow-left me-2"></i>Takaisin dashboardiin
                </a>
            </div>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- ALKUPERÄINEN SISÄLTÖ ALKAA TÄSTÄ -->
<!-- ============================================ -->
<div class="container">
    <div id="loadingScreen" class="text-center py-5">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Ladataan...</span>
        </div>
        <p class="mt-3 text-muted">Ladataan kysymyksiä...</p>
    </div>

    <div id="errorScreen" class="text-center py-5" style="display: none;">
        <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
            <h4 class="alert-heading">Virhe kysymysten lataamisessa</h4>
            <p id="errorMessage">Tapahtui odottamaton virhe.</p>
            <hr>
            <button class="btn btn-primary" onclick="location.reload()">
                <i class="fas fa-redo me-2"></i>Yritä uudelleen
            </button>
            <a href="{{ url_for('dashboard_route') }}" class="btn btn-secondary">
                <i class="fas fa-home me-2"></i>Palaa dashboardiin
            </a>
        </div>
    </div>

    <div id="questionScreen" style="display: none;">
         <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
            <div class="mb-2 mb-md-0">
                <h2 class="mb-0">
                    <i class="fas fa-book-open text-primary me-2"></i>
                    Harjoittele
                </h2>
            </div>
            <div class="flex-grow-1 ms-md-4">
                <div class="d-flex justify-content-end mb-1">
                    <span id="progressText" class="fw-bold text-muted">Kysymys 0 / 0</span>
                </div>
                <div class="progress" style="height: 12px;">
                    <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body p-4">
                <div id="question-progress-info" class="alert alert-info mb-3" style="display: none;">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <small class="text-muted">Edistymisesi tässä kysymyksessä:</small>
                            <div class="d-flex gap-3 mt-1">
                                <span><i class="fas fa-eye"></i> Nähty: <strong id="prog-times-shown">0</strong> kertaa</span>
                                <span><i class="fas fa-check-circle text-success"></i> Oikein: <strong id="prog-times-correct">0</strong></span>
                                <span><i class="fas fa-chart-line"></i> Onnistuminen: <strong id="prog-success-rate">0%</strong></span>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <small class="text-muted">Viimeksi: <span id="prog-last-shown">-</span></small>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h4 class="card-title mb-0 flex-grow-1" id="questionText">Kysymystä ladataan...</h4>
                    <button class="btn btn-outline-info btn-sm ms-3" onclick="openHelper()" title="Avaa avustaja">
                        <i class="fas fa-lightbulb me-1"></i>Avustaja
                    </button>
                </div>
                <div id="optionsContainer"></div>
            </div>
        </div>

        <div class="d-flex justify-content-between">
            <button id="submitBtn" class="btn btn-primary btn-lg" onclick="submitAnswer()">
                <i class="fas fa-check me-2"></i>Vastaa
            </button>
            <button id="nextBtn" class="btn btn-success btn-lg" onclick="nextQuestion()" style="display: none;">
                <i class="fas fa-arrow-right me-2"></i>Seuraava
            </button>
            <a href="{{ url_for('dashboard_route') }}" class="btn btn-secondary btn-lg">
                <i class="fas fa-times me-2"></i>Lopeta
            </a>
        </div>
    </div>

    <div id="resultsScreen" style="display: none;">
        <div class="text-center py-5">
            <i id="resultsIcon" class="fas fa-trophy fa-5x text-warning mb-4"></i>
            <h2 id="resultsTitle" class="mb-3">Hienoa työtä!</h2>
            <div class="card shadow-sm d-inline-block">
                <div class="card-body p-4">
                    <h3 class="display-4 mb-2" id="scoreText">0/0</h3>
                    <p class="text-muted mb-0" id="percentageText">0%</p>
                </div>
            </div>
            <div class="mt-4">
                <button class="btn btn-primary btn-lg me-2" onclick="location.reload()">
                    <i class="fas fa-redo me-2"></i>Harjoittele uudelleen
                </button>
                <a href="{{ url_for('dashboard_route') }}" class="btn btn-secondary btn-lg">
                    <i class="fas fa-home me-2"></i>Palaa dashboardiin
                </a>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="distractorModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-warning">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Häiriötilanne!
                </h5>
            </div>
            <div class="modal-body">
                <p class="fw-bold" id="distractor-scenario"></p>
                <p><strong>Miten toimit?</strong></p>
                <div id="distractor-options" class="d-grid gap-2"></div>
                <div id="distractor-feedback" class="d-none mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" id="distractor-action-btn" class="btn btn-warning">Vastaa</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="explanationModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" id="modalHeader">
                <h5 class="modal-title" id="modalTitle">Selitys</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                Selitystä ladataan...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-lg" onclick="continueToNext()">
                    <i class="fas fa-arrow-right me-2"></i>Jatka
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="helperModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-lightbulb me-2"></i>Avustaja
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3"><strong>Käytössäsi olevat työkalut:</strong></p>
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="fas fa-calculator text-primary me-2"></i>
                        <strong>Laskin:</strong> Klikkaa oikeasta alakulmasta
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-book text-success me-2"></i>
                        <strong>Lääketaulukko:</strong> Peruslääketiedot saatavilla kysymyksen jälkeen
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-clock text-warning me-2"></i>
                        <strong>Aikaa ei rajoiteta:</strong> Voit miettiä rauhassa
                    </li>
                </ul>
                <div class="alert alert-info mb-0">
                    <small>
                        <i class="fas fa-info-circle me-1"></i>
                        Vinkki: Lue kysymys huolellisesti ja mieti ensin itse vastausta ennen vaihtoehtojen tarkastelua!
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Sulje</button>
            </div>
        </div>
    </div>
</div>

<!-- Floating Calculator -->
<div id="floatingCalculator" class="floating-calculator">
    <div class="calculator-header" id="calcHeader">
        <span><i class="fas fa-calculator me-2"></i>Laskin</span>
        <button id="closeCalculator" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 0; width: 30px; height: 30px;">
            ×
        </button>
    </div>
    <div class="calculator-body">
        <input type="text" id="calcDisplay" class="calculator-display" value="0" readonly>
        <div class="calculator-buttons">
            <button class="calc-btn" data-value="7">7</button>
            <button class="calc-btn" data-value="8">8</button>
            <button class="calc-btn" data-value="9">9</button>
            <button class="calc-btn calc-operator" data-value="/">÷</button>
            
            <button class="calc-btn" data-value="4">4</button>
            <button class="calc-btn" data-value="5">5</button>
            <button class="calc-btn" data-value="6">6</button>
            <button class="calc-btn calc-operator" data-value="*">×</button>
            
            <button class="calc-btn" data-value="1">1</button>
            <button class="calc-btn" data-value="2">2</button>
            <button class="calc-btn" data-value="3">3</button>
            <button class="calc-btn calc-operator" data-value="-">−</button>
            
            <button class="calc-btn" data-value="0">0</button>
            <button class="calc-btn" data-value=".">.</button>
            <button class="calc-btn calc-equals" id="calcEquals">=</button>
            <button class="calc-btn calc-operator" data-value="+">+</button>
            
            <button class="calc-clear" id="calcClear">Tyhjennä</button>
        </div>
    </div>
</div>

<!-- Calculator Toggle Button -->
<button id="calculatorToggle" class="floating-calculator-toggle">
    <i class="fas fa-calculator"></i> Laskin
</button>

<script>
    let questions = [];
    let currentQuestionIndex = 0;
    let correctAnswers = 0;
    let selectedOption = null;
    let startTime = null;
    let distractorStartTime = null;
    let explanationModal = null;
    let helperModal = null;
    let currentDistractor = null;
    let distractorModalInstance = null;
    let csrfToken = '';

    const DISTRACTORS = {{ constants.DISTRACTORS|tojson|safe }};
    const userDistractorsEnabled = {{ current_user.distractors_enabled|tojson|safe }};
    const userDistractorProbability = {{ current_user.distractor_probability|tojson|safe }} / 100.0;

    // ============================================
    // KORJATTU: DOMContentLoaded
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
        fetchCSRFToken().then(() => {
            explanationModal = new bootstrap.Modal(document.getElementById('explanationModal'));
            helperModal = new bootstrap.Modal(document.getElementById('helperModal'));
            distractorModalInstance = new bootstrap.Modal(document.getElementById('distractorModal'));
            initCalculator();
            
            // Tarkista onko URL-parametreja
            const urlParams = new URLSearchParams(window.location.search);
            const hasParams = urlParams.has('categories') || urlParams.has('difficulties');
            
            if (hasParams) {
                // Parametrit löytyvät → piilota setup ja lataa kysymykset heti
                document.getElementById('setupScreen').style.display = 'none';
                document.getElementById('loadingScreen').style.display = 'block';
                fetchQuestions();
            } else {
                // Ei parametreja → näytä valintanäkymä
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('setupScreen').style.display = 'block';
                
                // Lomakkeen submit-käsittelijä
                const setupForm = document.getElementById('practiceSetupForm');
                if (setupForm) {
                    setupForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        handleSetupFormSubmit();
                    });
                }
            }
        });
    });

    // ============================================
    // UUSI: Valintanäkymän käsittelijät
    // ============================================
    function selectAllCategories() {
        document.querySelectorAll('.category-checkbox').forEach(cb => cb.checked = true);
    }

    function deselectAllCategories() {
        document.querySelectorAll('.category-checkbox').forEach(cb => cb.checked = false);
    }

    function handleSetupFormSubmit() {
        // Validoi valinnat
        const formData = new FormData(document.getElementById('practiceSetupForm'));
        const categories = formData.getAll('categories');
        const difficulties = formData.getAll('difficulties');
        const count = formData.get('count');

        const errorDiv = document.getElementById('setupError');
        const errorMsg = document.getElementById('setupErrorMessage');

        // Tarkistukset
        if (categories.length === 0) {
            errorMsg.textContent = 'Valitse vähintään yksi kategoria!';
            errorDiv.classList.remove('d-none');
            return;
        }

        if (difficulties.length === 0) {
            errorMsg.textContent = 'Valitse vähintään yksi vaikeustaso!';
            errorDiv.classList.remove('d-none');
            return;
        }

        const countNum = parseInt(count);
        if (isNaN(countNum) || countNum < 1 || countNum > 100) {
            errorMsg.textContent = 'Kysymysten määrän tulee olla 1-100!';
            errorDiv.classList.remove('d-none');
            return;
        }

        // Piilota virhe jos oli näkyvissä
        errorDiv.classList.add('d-none');

        // Rakenna URL-parametrit
        const params = new URLSearchParams();
        categories.forEach(c => params.append('categories', c));
        difficulties.forEach(d => params.append('difficulties', d));
        params.append('count', count);

        // Päivitä URL (history API)
        history.replaceState(null, '', `?${params.toString()}`);

        // Piilota setup ja näytä loading
        document.getElementById('setupScreen').style.display = 'none';
        document.getElementById('loadingScreen').style.display = 'block';

        // Lataa kysymykset
        fetchQuestions();
    }

    // Calculator functionality - WORKING VERSION from simulation.html
    function initCalculator() {
        const calcDisplay = document.getElementById('calcDisplay');
        const calculator = document.getElementById('floatingCalculator');
        const toggleBtn = document.getElementById('calculatorToggle');
        const closeBtn = document.getElementById('closeCalculator');
        const calcHeader = document.getElementById('calcHeader');

        if (!calculator || !toggleBtn || !calcDisplay) {
            console.error('Calculator elements not found');
            return;
        }

        // Calculator state
        let currentValue = '0';
        let previousValue = '';
        let operation = null;
        let shouldResetDisplay = false;

        // Drag state
        let isDragging = false;
        let currentX = 0;
        let currentY = 0;
        let initialX = 0;
        let initialY = 0;

        // Toggle calculator
        toggleBtn.addEventListener('click', () => {
            calculator.classList.add('show');
            toggleBtn.style.display = 'none';
        });

        // Close calculator
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                calculator.classList.remove('show');
                toggleBtn.style.display = 'block';
            });
        }

        // Calculator buttons
        document.querySelectorAll('.calc-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const value = this.dataset.value;
                
                if (['+', '-', '*', '/'].includes(value)) {
                    // Operator clicked
                    if (operation !== null && !shouldResetDisplay) {
                        calculateResult();
                    }
                    previousValue = currentValue;
                    operation = value;
                    shouldResetDisplay = true;
                } else if (value === '.') {
                    if (!currentValue.includes('.')) {
                        currentValue += '.';
                        calcDisplay.value = currentValue;
                    }
                } else {
                    // Number clicked
                    if (shouldResetDisplay) {
                        currentValue = value;
                        shouldResetDisplay = false;
                    } else {
                        currentValue = currentValue === '0' ? value : currentValue + value;
                    }
                    calcDisplay.value = currentValue;
                }
            });
        });

        // Clear button
        const clearBtn = document.getElementById('calcClear');
        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                currentValue = '0';
                previousValue = '';
                operation = null;
                shouldResetDisplay = false;
                calcDisplay.value = currentValue;
            });
        }

        // Equals button
        const equalsBtn = document.getElementById('calcEquals');
        if (equalsBtn) {
            equalsBtn.addEventListener('click', () => {
                calculateResult();
            });
        }

        function calculateResult() {
            if (operation === null || previousValue === '') return;
            
            try {
                const prev = parseFloat(previousValue);
                const current = parseFloat(currentValue);
                let result = 0;

                switch(operation) {
                    case '+': result = prev + current; break;
                    case '-': result = prev - current; break;
                    case '*': result = prev * current; break;
                    case '/': result = prev / current; break;
                }

                currentValue = result.toString();
                calcDisplay.value = currentValue;
                previousValue = '';
                operation = null;
                shouldResetDisplay = true;
            } catch (error) {
                currentValue = 'Error';
                calcDisplay.value = currentValue;
                shouldResetDisplay = true;
            }
        }

        // Drag functionality
        function dragStart(e) {
            if (e.type === 'touchstart') {
                initialX = e.touches[0].clientX - currentX;
                initialY = e.touches[0].clientY - currentY;
            } else {
                initialX = e.clientX - currentX;
                initialY = e.clientY - currentY;
            }

            if (e.target === calcHeader || e.target.parentElement === calcHeader) {
                isDragging = true;
            }
        }

        function drag(e) {
            if (!isDragging) return;
            
            e.preventDefault();
            
            let clientX, clientY;
            if (e.type === 'touchmove') {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            currentX = clientX - initialX;
            currentY = clientY - initialY;

            const maxX = window.innerWidth - calculator.offsetWidth;
            const maxY = window.innerHeight - calculator.offsetHeight;
            
            currentX = Math.max(0, Math.min(currentX, maxX));
            currentY = Math.max(0, Math.min(currentY, maxY));

            calculator.style.left = currentX + 'px';
            calculator.style.top = currentY + 'px';
        }

        function dragEnd() {
            isDragging = false;
        }

        // Mouse events
        calcHeader.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);

        // Touch events
        calcHeader.addEventListener('touchstart', dragStart, { passive: false });
        document.addEventListener('touchmove', drag, { passive: false });
        document.addEventListener('touchend', dragEnd);
    }

    async function fetchCSRFToken() {
        try {
            const response = await fetch('/api/csrf-token');
            const data = await response.json();
            csrfToken = data.csrf_token;
            console.log('CSRF-token haettu onnistuneesti');
        } catch (error) {
            console.error('CSRF-tokenin haku epäonnistui:', error);
            setTimeout(fetchCSRFToken, 2000);
        }
    }

    // ============================================
    // KORJATTU: fetchQuestions
    // ============================================
    async function fetchQuestions() {
        try {
            // Lue parametrit URL:sta
            const urlParams = new URLSearchParams(window.location.search);
            const categories = urlParams.getAll('categories');
            const difficulties = urlParams.getAll('difficulties');
            const limit = urlParams.get('count') || '10';
            const source = urlParams.get('source');

            console.log('Haetaan kysymyksiä:', { categories, difficulties, limit, source });

            const limitNum = parseInt(limit);

            // Tarkista rajoitus (paitsi jos lähde on 'mistakes')
            if (source !== 'mistakes') {
                if (isNaN(limitNum) || limitNum < 1 || limitNum > 100) {
                    throw new Error('Kysymysten määrän tulee olla 1-100 välillä');
                }
            }
            
            // Rakenna API-kutsu
            const apiUrl = new URL('/api/questions', window.location.origin);
            apiUrl.searchParams.append('count', limitNum); 
            categories.forEach(cat => apiUrl.searchParams.append('categories', cat));
            difficulties.forEach(diff => apiUrl.searchParams.append('difficulties', diff));
            
            const response = await fetch(apiUrl);
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (!data.questions || !Array.isArray(data.questions) || data.questions.length === 0) {
                throw new Error('Ei kysymyksiä saatavilla valituilla kriteereillä.');
            }
            
            questions = data.questions;
            startTime = Date.now();
            showScreen('question');
            displayCurrentQuestion();
        } catch (error) {
            console.error('Virhe kysymysten haussa:', error);
            let userMessage = error.message.includes('NetworkError') || error.message.includes('Failed to fetch') 
                ? 'Verkkovirhe. Tarkista internet-yhteytesi ja yritä uudelleen.'
                : error.message || 'Kysymysten lataaminen epäonnistui.';
            showScreen('error', userMessage);
        }
    }

    function continueToNext() {
        explanationModal.hide();
        nextQuestion();
    }

    function showScreen(screenName, errorMsg = null) {
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('errorScreen').style.display = 'none';
        document.getElementById('questionScreen').style.display = 'none';
        document.getElementById('resultsScreen').style.display = 'none';

        if (screenName === 'loading') {
            document.getElementById('loadingScreen').style.display = 'block';
        } else if (screenName === 'error') {
            document.getElementById('errorScreen').style.display = 'block';
            if (errorMsg) {
                document.getElementById('errorMessage').textContent = errorMsg;
            }
        } else if (screenName === 'question') {
            document.getElementById('questionScreen').style.display = 'block';
        } else if (screenName === 'results') {
            document.getElementById('resultsScreen').style.display = 'block';
        }
    }

    function displayCurrentQuestion() {
    if (currentQuestionIndex >= questions.length) {
        showResults();
        return;
    }
    const question = questions[currentQuestionIndex];
    selectedOption = null;
    document.getElementById('progressBar').style.width = `${((currentQuestionIndex + 1) / questions.length) * 100}%`;
    document.getElementById('progressText').textContent = `${currentQuestionIndex + 1}/${questions.length}`;
    loadQuestionProgress(question.id);
    document.getElementById('questionText').textContent = question.question;
    const optionsContainer = document.getElementById('optionsContainer');
    optionsContainer.innerHTML = '';
    question.options.forEach((option, index) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'form-check p-3 mb-2 border rounded option-item';
        optionDiv.style.cursor = 'pointer';
        optionDiv.onclick = () => selectOption(index);
        optionDiv.innerHTML = `
            <input class="form-check-input" type="radio" name="answer" id="option${index}" value="${index}">
            <label class="form-check-label w-100" for="option${index}" style="cursor: pointer;">${String.fromCharCode(65 + index)}. ${option}</label>
        `;
        optionsContainer.appendChild(optionDiv);
    });

    // KORJAUS TÄSSÄ: Varmistetaan, että oikeat napit näkyvät uuden kysymyksen alussa
    document.getElementById('submitBtn').style.display = 'inline-block';
    document.getElementById('nextBtn').style.display = 'none';
    
    if (currentQuestionIndex > 0 && userDistractorsEnabled && Math.random() < userDistractorProbability) {
        showDistractor();
    }
}
    
    function showDistractor() {
        distractorStartTime = Date.now();
        currentDistractor = DISTRACTORS[Math.floor(Math.random() * DISTRACTORS.length)];
        
        document.getElementById('distractor-scenario').textContent = currentDistractor.scenario;
        const optionsContainer = document.getElementById('distractor-options');
        optionsContainer.innerHTML = '';
        
        const actionBtn = document.getElementById('distractor-action-btn');
        actionBtn.style.display = 'none';

        currentDistractor.options.forEach((opt, index) => {
            const button = document.createElement('button');
            button.className = 'btn btn-outline-secondary distractor-option';
            button.textContent = opt;
            button.onclick = () => submitDistractor(index);
            optionsContainer.appendChild(button);
        });

        document.getElementById('distractor-feedback').classList.add('d-none');
        distractorModalInstance.show();
    }

    async function submitDistractor(selectedOptionIndex) {
        document.querySelectorAll('.distractor-option').forEach(btn => {
            btn.disabled = true;
            if (btn.textContent === currentDistractor.options[selectedOptionIndex]) {
                btn.classList.add('active');
            }
        });
        
        const responseTime = Math.floor((Date.now() - distractorStartTime) / 1000);
        
        try {
            if (!csrfToken) {
                await fetchCSRFToken();
            }
            
            const response = await fetch('/api/submit_distractor', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    scenario: currentDistractor.scenario,
                    user_choice: selectedOptionIndex,
                    response_time: responseTime
                })
            });
            
            if (!response.ok) {
                throw new Error('Distractorin tallennus epäonnistui');
            }
            
            const data = await response.json();
            const isCorrect = data.is_correct;
            const feedback = document.getElementById('distractor-feedback');
            
            feedback.className = isCorrect ? 'alert alert-success' : 'alert alert-danger';
            feedback.innerHTML = `
                <h6><i class="fas ${isCorrect ? 'fa-check-circle' : 'fa-times-circle'}"></i> ${isCorrect ? 'Oikein!' : 'Väärin'}</h6>
                <p class="mb-0">${currentDistractor.correct_action}</p>
            `;
            feedback.classList.remove('d-none');
            
            setTimeout(() => {
                distractorModalInstance.hide();
            }, 3000);
            
        } catch (error) {
            console.error('Virhe distractorin tallennuksessa:', error);
        }
    }

    function selectOption(index) {
        selectedOption = index;
        document.querySelectorAll('.option-item').forEach((item, i) => {
            item.classList.remove('selected');
            if (i === index) {
                item.classList.add('selected');
            }
        });
        document.getElementById(`option${index}`).checked = true;
    }

    async function submitAnswer() {
        if (selectedOption === null) {
            alert('Valitse vastaus ensin!');
            return;
        }

        const submitBtn = document.getElementById('submitBtn');
        const nextBtn = document.getElementById('nextBtn');
        submitBtn.disabled = true;

        const question = questions[currentQuestionIndex];
        const responseTime = Math.floor((Date.now() - startTime) / 1000);
        
        try {
            if (!csrfToken) {
                await fetchCSRFToken();
            }
            
            const response = await fetch('/api/submit_answer', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    question_id: question.id,
                    user_answer: selectedOption,
                    response_time: responseTime
                })
            });
            
            if (!response.ok) {
                throw new Error('Vastauksen lähetys epäonnistui');
            }
            
            const data = await response.json();
            const isCorrect = data.is_correct;
            const correctIndex = data.correct_answer;
            const explanation = data.explanation;
            
            if (isCorrect) {
                correctAnswers++;
            }

            document.querySelectorAll('.option-item').forEach((item, i) => {
                item.style.pointerEvents = 'none';
                if (i === correctIndex) {
                    item.classList.add('correct');
                } else if (i === selectedOption && !isCorrect) {
                    item.classList.add('incorrect');
                }
            });

            submitBtn.style.display = 'none';
            nextBtn.style.display = 'inline-block';

            const modalHeader = document.getElementById('modalHeader');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            if (isCorrect) {
                modalHeader.className = 'modal-header bg-success text-white';
                modalTitle.innerHTML = '<i class="fas fa-check-circle me-2"></i>Oikein!';
            } else {
                modalHeader.className = 'modal-header bg-danger text-white';
                modalTitle.innerHTML = '<i class="fas fa-times-circle me-2"></i>Väärin';
            }
            
            modalBody.innerHTML = explanation || 'Ei selitystä saatavilla.';
            explanationModal.show();
            
        } catch (error) {
            console.error('Virhe vastauksen lähetyksessä:', error);
            alert('Virhe vastauksen tallennuksessa. Yritä uudelleen.');
            submitBtn.disabled = false;
        }
    }

    function nextQuestion() {
        currentQuestionIndex++;
        startTime = Date.now();
        displayCurrentQuestion();
    }

    function showResults() {
        const percentage = Math.round((correctAnswers / questions.length) * 100);
        document.getElementById('scoreText').textContent = `${correctAnswers}/${questions.length}`;
        document.getElementById('percentageText').textContent = `${percentage}%`;
        
        const icon = document.getElementById('resultsIcon');
        const title = document.getElementById('resultsTitle');
        
        if (percentage >= 80) {
            icon.className = 'fas fa-trophy fa-5x text-warning mb-4';
            title.textContent = 'Erinomaista!';
        } else if (percentage >= 60) {
            icon.className = 'fas fa-thumbs-up fa-5x text-success mb-4';
            title.textContent = 'Hyvää työtä!';
        } else {
            icon.className = 'fas fa-redo fa-5x text-primary mb-4';
            title.textContent = 'Jatka harjoittelua!';
        }
        
        showScreen('results');
    }

    async function loadQuestionProgress(questionId) {
        try {
            const response = await fetch(`/api/question-progress/${questionId}`);
            if (!response.ok) return;
            
            const data = await response.json();
            const info = document.getElementById('question-progress-info');
            
            if (data.times_shown > 0) {
                document.getElementById('prog-times-shown').textContent = data.times_shown;
                document.getElementById('prog-times-correct').textContent = data.times_correct;
                document.getElementById('prog-success-rate').textContent = `${data.success_rate}%`;
                document.getElementById('prog-last-shown').textContent = data.last_shown_formatted || '-';
                info.style.display = 'block';
            } else {
                info.style.display = 'none';
            }
        } catch (error) {
            console.error('Virhe progressin haussa:', error);
        }
    }

    function openHelper() {
        helperModal.show();
    }
</script>

<style>
    .option-item {
        transition: all 0.2s;
        background: white;
    }
    
    .option-item:hover {
        background: #f8f9fa;
        border-color: #0d6efd !important;
        transform: translateX(5px);
    }
    
    .option-item.selected {
        background: #e7f3ff;
        border-color: #0d6efd !important;
    }
    
    .option-item.correct {
        background: #d1f2eb !important;
        border-color: #28a745 !important;
    }
    
    .option-item.incorrect {
        background: #f8d7da !important;
        border-color: #dc3545 !important;
    }

    /* Setup Screen Styles */
    .hover-shadow:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .cursor-pointer {
        cursor: pointer;
    }

    /* Calculator Styles */
    .floating-calculator {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 320px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        display: none;
    }

    .floating-calculator.show {
        display: block;
    }

    .calculator-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 16px;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        cursor: move;
        user-select: none;
    }

    .calculator-header:active {
        cursor: grabbing;
    }

    .calculator-body {
        padding: 16px;
    }

    .calculator-display {
        width: 100%;
        padding: 16px;
        font-size: 24px;
        text-align: right;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        margin-bottom: 16px;
        background: #f7fafc;
        font-weight: 600;
    }

    .calculator-buttons {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
    }

    .calc-btn {
        padding: 16px;
        font-size: 18px;
        border: none;
        border-radius: 8px;
        background: #e2e8f0;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 600;
    }

    .calc-btn:hover {
        background: #cbd5e0;
        transform: translateY(-2px);
    }

    .calc-operator {
        background: #fbbf24;
        color: white;
    }

    .calc-operator:hover {
        background: #f59e0b;
    }

    .calc-equals {
        background: #10b981;
        color: white;
    }

    .calc-equals:hover {
        background: #059669;
    }

    .calc-clear {
        grid-column: span 4;
        padding: 12px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
    }

    .calc-clear:hover {
        background: #dc2626;
    }

    .floating-calculator-toggle {
        position: fixed;
        right: 20px;
        bottom: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 50px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        font-weight: 600;
        z-index: 999;
        transition: all 0.3s;
    }

    .floating-calculator-toggle:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    }

    .floating-calculator-toggle i {
        margin-right: 8px;
    }
</style>
{% endblock %}