{% extends "base.html" %}

{% block title %}Koesimulaatio - LOVe Enhanced{% endblock %}

{% block extra_head %}
<style>
    /* üé® Simulaatio: Vahvempi tausta, ei animaatiota */
    body {
        animation: none !important;
        background: #f0f4f8 !important;
    }
    
    body::before {
        background: rgba(240, 244, 248, 0.98) !important;
    }
    
    body.dark-mode {
        background: #0f1419 !important;
    }
    
    body.dark-mode::before {
        background: rgba(15, 20, 25, 0.98) !important;
    }
    
    /* Navbar yh√§ glassmorphism */
    .navbar {
        background: rgba(255, 255, 255, 0.15) !important;
    }
    
    body.dark-mode .navbar {
        background: rgba(15, 15, 15, 0.5) !important;
    }
    
    /* Sis√§lt√∂ selke√§sti n√§kyviss√§ */
    .card {
        background: rgba(255, 255, 255, 0.98) !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
    }
    
    body.dark-mode .card {
        background: rgba(30, 30, 30, 0.98) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div id="start-screen" class="card shadow-lg border-0" style="display: none;">
        <div class="card-body text-center p-5">
            <div class="mb-4"><i class="fas fa-clipboard-check fa-4x text-primary"></i></div>
            <h1 class="display-4 mb-4">Koesimulaatio</h1>
            
            {% if has_existing_session %}
            <div class="alert alert-warning mx-auto mb-4" style="max-width: 700px;">
                <h5 class="alert-heading mb-3"><i class="fas fa-exclamation-triangle"></i> Sinulla on kesken oleva koe</h5>
                 <div class="row text-start">
                    <div class="col-md-6">
                        <p class="mb-2"><i class="fas fa-question-circle text-primary"></i> <strong>Kysymys {{ session_info.current_index }}/{{ session_info.total }}</strong></p>
                        <p class="mb-0"><i class="fas fa-check-circle text-success"></i> Vastattu: <strong>{{ session_info.answered }}</strong></p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-0"><i class="fas fa-clock text-danger"></i> Aikaa j√§ljell√§: <strong>~{{ session_info.time_remaining_minutes }} min</strong></p>
                    </div>
                </div>
                <hr>
                <div class="d-flex justify-content-center flex-wrap gap-2">
                    <a href="{{ url_for('simulation_route', resume='true') }}" class="btn btn-primary"><i class="fas fa-play me-2"></i>Jatka koetta</a>
                    <a href="{{ url_for('simulation_route', new='true') }}" class="btn btn-danger" onclick="return confirm('Haluatko varmasti aloittaa uuden kokeen? Kesken oleva koe poistetaan pysyv√§sti.')"><i class="fas fa-trash-alt me-2"></i>Hylk√§√§ ja aloita uusi</a>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info mx-auto mb-4" style="max-width: 700px;">
                <h5 class="alert-heading">Kokeen s√§√§nn√∂t</h5>
                <ul class="text-start mb-0">
                    <li>Kokeessa on <strong>50 kysymyst√§</strong>.</li>
                    <li>Aikaa on <strong>60 minuuttia</strong>.</li>
                </ul>
            </div>
            <a href="{{ url_for('simulation_route', new='true') }}" class="btn btn-primary btn-lg"><i class="fas fa-play me-2"></i>Aloita koe</a>
            {% endif %}
        </div>
    </div>

    <!-- 3-2-1 Countdown Modal -->
    <div id="countdown-modal" class="d-none" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div class="text-center">
            <div id="countdown-number" class="display-1 fw-bold text-white" style="font-size: 150px;"></div>
            <p class="text-white fs-3 mt-3">Valmistaudu...</p>
        </div>
    </div>

    <div id="simulation-container" class="d-none"></div>

    <div id="results-screen" class="d-none"></div>
</div>

<button id="floating-calculator-btn" class="btn btn-primary rounded-circle shadow-lg d-none" onclick="toggleCalculator()" title="Avaa laskin" style="position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; z-index: 1000;"><i class="fas fa-calculator fa-lg"></i></button>
<div id="calculator-modal" style="display: none; position: fixed; bottom: 90px; right: 20px; z-index: 1001; width: 300px;">
    {% include '_calculator_modal.html' %}
</div>
{% endblock %}


{% block extra_scripts %}
<script>
    const initialSessionData = {{ session_data | tojson }};
    
    
    let questionsCache = {};
    let answers = [];
    let questionIds = [];
    let currentQuestionIndex = 0;
    let timerInterval;
    let timeRemaining;

    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('resume') && initialSessionData && initialSessionData.question_ids) {
            initializeSimulation();
        } else {
            document.getElementById('start-screen').style.display = 'block';
        }
        initCalculatorDrag();
    });

    async function initializeSimulation() {
        document.getElementById('start-screen').style.display = 'none';
        
        answers = initialSessionData.answers || [];
        questionIds = initialSessionData.question_ids || [];
        currentQuestionIndex = initialSessionData.current_index || 0;
        timeRemaining = initialSessionData.time_remaining || 3600;
        
        // Jos aloitetaan alusta (current_index = 0), n√§yt√§ countdown
        if (currentQuestionIndex === 0) {
            await showCountdown();
        }
        
        document.getElementById('floating-calculator-btn').classList.remove('d-none');
        buildSimulationView();
        await showQuestion(currentQuestionIndex);
        startTimer();
    }

    // 3-2-1 Countdown
    async function showCountdown() {
        const modal = document.getElementById('countdown-modal');
        const numberEl = document.getElementById('countdown-number');
        modal.classList.remove('d-none');
        modal.style.display = 'flex';
        
        const numbers = [3, 2, 1, 'ALOITA!'];
        
        for (let num of numbers) {
            numberEl.textContent = num;
            numberEl.style.animation = 'none';
            setTimeout(() => {
                numberEl.style.animation = 'pulse 1s ease-in-out';
            }, 10);
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        modal.style.display = 'none';
        modal.classList.add('d-none');
    }

    function buildSimulationView() {
        const container = document.getElementById('simulation-container');
        container.classList.remove('d-none');
        container.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">Koesimulaatio</h2>
                <div id="timer" class="fs-4 fw-bold badge bg-danger-subtle text-danger-emphasis p-2"></div>
            </div>
            <div class="progress mb-4" style="height: 8px;"><div id="progress-bar" class="progress-bar"></div></div>
            <div class="row">
                <div class="col-lg-8"><div class="card shadow-sm"><div class="card-body p-4" id="question-content-wrapper"></div></div></div>
                <div class="col-lg-4 mt-4 mt-lg-0">
                    <div class="card shadow-sm">
                        <div class="card-header">Kysymysnavigaatio</div>
                        <div class="card-body"><div id="question-grid" class="d-grid gap-2" style="grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));"></div></div>
                    </div>
                    <div class="d-grid gap-2 mt-3">
                        <button id="finish-btn" class="btn btn-success"><i class="fas fa-check-double me-2"></i>Tarkista ja palauta koe</button>
                        <button id="save-quit-btn" class="btn btn-outline-secondary"><i class="fas fa-save me-2"></i>Tallenna ja poistu</button>
                    </div>
                </div>
            </div>`;
            
        buildQuestionGrid();
        updateProgress();
        document.getElementById('finish-btn').addEventListener('click', confirmFinish);
        document.getElementById('save-quit-btn').addEventListener('click', saveAndQuit);
    }
    
    async function showQuestion(index) {
        currentQuestionIndex = index;
        const wrapper = document.getElementById('question-content-wrapper');
        wrapper.innerHTML = `<div class="text-center p-5"><div class="spinner-border"></div></div>`;
        updateQuestionGrid();

        let question = questionsCache[index];
        if (!question) {
            try {
                const response = await fetch(`/api/simulation/question/${index}`);
                if (!response.ok) throw new Error('Kysymyksen haku ep√§onnistui');
                question = await response.json();
                questionsCache[index] = question;
            } catch (error) {
                wrapper.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
                return;
            }
        }
        
        let optionsHtml = question.options.map((option, i) => `
            <div class="form-check">
                <input class="form-check-input" type="radio" name="answer" id="option${i}" value="${i}" ${answers[index] === i ? 'checked' : ''}>
                <label class="form-check-label p-2 border rounded" for="option${i}" style="cursor:pointer; width: 100%;">
                    ${String.fromCharCode(65 + i)}. ${option}
                </label>
            </div>
        `).join('');
        
        // M√§√§rit√§ seuraava-napin teksti ja toiminto
        const isLastQuestion = index === questionIds.length - 1;
        const nextButtonText = isLastQuestion ? '<i class="fas fa-flag-checkered me-2"></i>Viimeinen kysymys' : '<i class="fas fa-arrow-right me-2"></i>Seuraava kysymys';
        const nextButtonClass = isLastQuestion ? 'btn-warning' : 'btn-primary';
            
        wrapper.innerHTML = `
            <h5 class="card-title">Kysymys ${index + 1} / ${questionIds.length}</h5>
            <p class="fs-5">${question.question}</p>
            <div class="d-grid gap-3 mt-4 mb-4">${optionsHtml}</div>
            <div class="d-flex gap-2 justify-content-between">
                <button id="prev-btn" class="btn btn-outline-secondary" ${index === 0 ? 'disabled' : ''}>
                    <i class="fas fa-arrow-left me-2"></i>Edellinen
                </button>
                <button id="next-btn" class="btn ${nextButtonClass}">
                    ${nextButtonText}
                </button>
            </div>
        `;
        
        // Lis√§√§ event listenerit vastausvalinnoille
        wrapper.querySelectorAll('input[name="answer"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                answers[currentQuestionIndex] = parseInt(e.target.value);
                updateQuestionGrid();
                updateProgress();
            });
        });
        
        // Edellinen-nappi
        const prevBtn = document.getElementById('prev-btn');
        if (prevBtn && index > 0) {
            prevBtn.addEventListener('click', () => showQuestion(index - 1));
        }
        
        // Seuraava-nappi
        const nextBtn = document.getElementById('next-btn');
        nextBtn.addEventListener('click', () => {
            if (isLastQuestion) {
                // Jos viimeinen kysymys, vierit√§ yl√∂s n√§ytt√§m√§√§n "Palauta koe" -nappi
                window.scrollTo({ top: 0, behavior: 'smooth' });
                alert('Olet viimeisell√§ kysymyksell√§! Kun olet valmis, paina "Tarkista ja palauta koe" -nappia oikealla.');
            } else {
                // Siirry seuraavaan kysymykseen
                showQuestion(index + 1);
            }
        });
    }

    function buildQuestionGrid() {
        const grid = document.getElementById('question-grid');
        grid.innerHTML = '';
        for (let i = 0; i < questionIds.length; i++) {
            const btn = document.createElement('button');
            btn.className = 'btn btn-outline-secondary';
            btn.textContent = i + 1;
            btn.onclick = () => showQuestion(i);
            grid.appendChild(btn);
        }
        updateQuestionGrid();
    }

    function updateQuestionGrid() {
        const gridButtons = document.getElementById('question-grid').children;
        for (let i = 0; i < gridButtons.length; i++) {
            gridButtons[i].className = 'btn';
            if (i === currentQuestionIndex) {
                gridButtons[i].classList.add('btn-primary');
            } else if (answers[i] != null) {
                gridButtons[i].classList.add('btn-success');
            } else {
                gridButtons[i].classList.add('btn-outline-secondary');
            }
        }
    }

    function updateProgress() {
        if (questionIds.length === 0) return;
        const answeredCount = answers.filter(a => a !== null).length;
        const progress = (answeredCount / questionIds.length) * 100;
        const bar = document.getElementById('progress-bar');
        if (bar) bar.style.width = `${progress}%`;
    }

    function startTimer() {
        clearInterval(timerInterval);
        updateTimerDisplay();
        timerInterval = setInterval(() => {
            timeRemaining--;
            updateTimerDisplay();
            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                alert('Aika loppui! Koe tarkistetaan.');
                finishSimulation();
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        const timerEl = document.getElementById('timer');
        if (timerEl) {
            timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            if (timeRemaining <= 300) {
                timerEl.classList.add('text-danger');
            }
        }
    }

    function confirmFinish() {
        const unanswered = answers.filter(a => a === null).length;
        let message = 'Haluatko varmasti palauttaa kokeen?';
        if (unanswered > 0) {
            message += ` Sinulla on ${unanswered} vastaamatonta kysymyst√§.`;
        }
        if (confirm(message)) {
            finishSimulation();
        }
    }

    async function saveAndQuit() {
        if (confirm('Haluatko tallentaa edistymisesi ja poistua? Voit jatkaa my√∂hemmin.')) {
            await saveProgressToBackend();
            window.location.href = "{{ url_for('dashboard_route') }}";
        }
    }

    async function saveProgressToBackend(isFinishing = false) {
        try {
            const payload = {
                answers: answers,
                current_index: currentQuestionIndex,
                time_remaining: timeRemaining
            };
            if (isFinishing) payload.is_finishing = true;
            await fetch('/api/simulation/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify(payload)
            });
        } catch (e) {
            console.error('Failed to save progress:', e);
            alert("Tallennus ep√§onnistui. Tarkista verkkoyhteys.");
        }
    }

    async function finishSimulation() {
        clearInterval(timerInterval);
        await saveProgressToBackend(true);
        try {
            const response = await fetch('/api/submit_simulation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }
            });
            const result = await response.json();
            showResults(result);
        } catch (error) {
            console.error('Error finishing simulation:', error);
            alert('Virhe kokeen palautuksessa.');
        }
    }

    function showResults(result) {
        document.getElementById('simulation-container').classList.add('d-none');
        document.getElementById('floating-calculator-btn').classList.add('d-none');
        const resultsScreen = document.getElementById('results-screen');
        resultsScreen.classList.remove('d-none');
        let detailedResultsHtml = result.detailed_results.map((res, index) => `
            <div class="card mb-3">
                <div class="card-body">
                    <p><strong>${index + 1}. ${res.question}</strong></p>
                    <p class="${res.is_correct ? 'text-success' : 'text-danger'}">
                        <i class="fas ${res.is_correct ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                        Vastasit: ${res.user_answer_text || 'Ei vastattu'}
                    </p>
                    ${!res.is_correct ? `<p class="text-success">Oikea vastaus: ${res.correct_answer_text}</p>` : ''}
                    <p class="text-muted small">${res.explanation}</p>
                </div>
            </div>
        `).join('');
        resultsScreen.innerHTML = `
            <div class="card shadow-lg border-0 text-center p-4">
                <h1 class="display-4">Koe suoritettu!</h1>
                <p class="lead">Tuloksesi: <strong>${result.score} / ${result.total} (${result.percentage.toFixed(1)}%)</strong></p>
                <div class="d-flex justify-content-center gap-2 mt-3 mb-4">
                    <a href="{{ url_for('dashboard_route') }}" class="btn btn-primary">Palaa etusivulle</a>
                    <a href="{{ url_for('simulation_route', new='true') }}" class="btn btn-outline-secondary">Yrit√§ uudelleen</a>
                </div>
                <hr>
                <h3 class="mt-4">Vastausten erittely</h3>
                <div class="text-start mt-3" style="max-height: 400px; overflow-y: auto;">${detailedResultsHtml}</div>
            </div>
        `;
    }
    
    let isDragging = false, xOffset = 0, yOffset = 0, calcCurrentValue = '0', calcOperator = '', calcPreviousValue = '';
    
    function toggleCalculator() {
        const modal = document.getElementById('calculator-modal');
        modal.style.display = modal.style.display === 'none' ? 'block' : 'none';
    }

    function calcInput(value) {
        const display = document.getElementById('calc-display');
        if (['+', '-', '*', '/'].includes(value)) {
            calcOperator = value;
            calcPreviousValue = calcCurrentValue;
            calcCurrentValue = '0';
        } else if (value === '.') {
            if (!calcCurrentValue.includes('.')) calcCurrentValue += '.';
        } else {
            calcCurrentValue = calcCurrentValue === '0' ? value : calcCurrentValue + value;
        }
        display.value = calcCurrentValue;
    }

    function calcEqual() {
        const display = document.getElementById('calc-display');
        const prev = parseFloat(calcPreviousValue), curr = parseFloat(calcCurrentValue);
        let result = 0;
        switch(calcOperator) {
            case '+': result = prev + curr; break;
            case '-': result = prev - curr; break;
            case '*': result = prev * curr; break;
            case '/': result = prev / curr; break;
            default: return;
        }
        calcCurrentValue = result.toString();
        calcOperator = ''; calcPreviousValue = '';
        display.value = calcCurrentValue;
    }

    function calcClear() {
        calcCurrentValue = '0'; calcOperator = ''; calcPreviousValue = '';
        document.getElementById('calc-display').value = '0';
    }

    function initCalculatorDrag() {
        const calcHeader = document.getElementById('calc-header');
        const calcModal = document.getElementById('calculator-modal');
        if (!calcHeader || !calcModal) return;
        calcHeader.addEventListener('mousedown', dragStart);
        document.addEventListener('mouseup', dragEnd);
        document.addEventListener('mousemove', drag);
        calcHeader.addEventListener('touchstart', dragStart, { passive: false });
        document.addEventListener('touchend', dragEnd);
        document.addEventListener('touchmove', drag, { passive: false });
    }

    function dragStart(e) {
        const calcModal = document.getElementById('calculator-modal');
        isDragging = true;
        const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
        const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
        const rect = calcModal.getBoundingClientRect();
        if (calcModal.style.right || calcModal.style.bottom) {
            calcModal.style.right = 'auto';
            calcModal.style.bottom = 'auto';
            calcModal.style.top = rect.top + 'px';
            calcModal.style.left = rect.left + 'px';
        }
        xOffset = clientX - calcModal.offsetLeft;
        yOffset = clientY - calcModal.offsetTop;
    }

    function drag(e) {
        if (isDragging) {
            e.preventDefault();
            const calcModal = document.getElementById('calculator-modal');
            const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
            const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
            calcModal.style.left = (clientX - xOffset) + 'px';
            calcModal.style.top = (clientY - yOffset) + 'px';
        }
    }
    
    function dragEnd() {
        isDragging = false;
    }
</script>

<style>
    @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.8; }
    }
</style>
{% endblock %}