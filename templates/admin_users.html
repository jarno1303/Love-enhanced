{% extends "base.html" %}
{% block title %}K√§ytt√§jien hallinta{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">üë• K√§ytt√§jien hallinta</h1>
        <div>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createSingleUserModal">
                <i class="fas fa-user-plus me-2"></i>Luo yksitt√§inen k√§ytt√§j√§
            </button>
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createTestUsersModal">
                <i class="fas fa-users me-2"></i>Luo testik√§ytt√§ji√§
            </button>
            <a href="{{ url_for('admin_route') }}" class="btn btn-secondary">‚Üê Palaa Admin-paneeliin</a>
        </div>
    </div>
    
    <div class="card shadow-sm">
        <div class="card-header">
            Rekister√∂ityneet k√§ytt√§j√§t ({{ users|length }})
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>K√§ytt√§j√§nimi</th>
                            <th>S√§hk√∂posti</th>
                            <th>Rooli</th>
                            <th>Luotu</th>
                            <th>Tila</th>
                            <th>H√§iri√∂tekij√§t</th>
                            <th>Toiminnot</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.id }}</td>
                            <td>{{ user.username }}</td>
                            <td>{{ user.email }}</td>
                            <td>
                                {% if user.role == 'admin' %}
                                    <span class="badge bg-primary">Admin</span>
                                {% else %}
                                    <span class="badge bg-secondary">K√§ytt√§j√§</span>
                                {% endif %}
                            </td>
                            <td>{{ user.created_at.strftime('%Y-%m-%d') if user.created_at else '-' }}</td>
                            <td>
                                {% if user.status == 'active' %}
                                    <span class="badge bg-success">Aktiivinen</span>
                                {% else %}
                                    <span class="badge bg-danger">Estetty</span>
                                {% endif %}
                            </td>
                            <td>
                                {{ 'Kyll√§' if user.distractors_enabled else 'Ei' }} ({{ user.distractor_probability }}%)
                            </td>
                            <td>
                                {% if user.id != 1 %}
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-danger" onclick="showConfirm('delete', {{ user.id }}, '{{ user.username }}')">Poista</button>
                                    <button type="button" class="btn btn-outline-warning" onclick="showConfirm('toggle', {{ user.id }}, '{{ user.username }}')">{{ 'Est√§' if user.status == 'active' else 'Salli' }}</button>
                                    <button type="button" class="btn btn-outline-primary" onclick="showConfirm('role', {{ user.id }}, '{{ user.username }}')">{{ 'Tee admin' if user.role == 'user' else 'Poista admin' }}</button>
                                    <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#editSettingsModal-{{ user.id }}">Muokkaa</button>
                                </div>
                                {% else %}
                                <span class="text-muted small">P√§√§k√§ytt√§j√§</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmModalLabel">Vahvista poisto</h5>
            </div>
            <div class="modal-body" id="confirmModalBody">
                </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Peruuta</button>
                <form id="confirmDeleteForm" method="POST" style="display:inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">Vahvista poisto</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% for user in users %}
{% if user.id != 1 %}
<div class="modal fade" id="editSettingsModal-{{ user.id }}" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form action="{{ url_for('edit_user_settings', user_id=user.id) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="confirm" value="true">
                <div class="modal-header">
                    <h5 class="modal-title">Muokkaa asetuksia: {{ user.username }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">H√§iri√∂tekij√§t P√§√§ll√§</label>
                        <select class="form-select" name="distractors_enabled">
                            <option value="1" {% if user.distractors_enabled %}selected{% endif %}>‚úÖ Kyll√§</option>
                            <option value="0" {% if not user.distractors_enabled %}selected{% endif %}>‚ùå Ei</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Todenn√§k√∂isyys (%)</label>
                        <input type="number" class="form-control" name="distractor_probability" value="{{ user.distractor_probability }}" min="0" max="100" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Peruuta</button>
                    <button type="submit" class="btn btn-primary">Tallenna muutokset</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}

{% include 'create_test_users_modal.html' %}
{% include 'create_single_user_modal.html' %}

{% endblock %}

{% block extra_scripts %}
<script>
let confirmDeleteModal = null;

document.addEventListener('DOMContentLoaded', function() {
    confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
});

// UUSI: T√§ysin uusittu vahvistuslogiikka
function showConfirm(action, userId, username) {
    // 1. K√§sittele poisto uudella modaalilla
    if (action === 'delete') {
        document.getElementById('confirmModalLabel').textContent = `Vahvista k√§ytt√§j√§n poisto`;
        document.getElementById('confirmModalBody').innerHTML = `Haluatko varmasti <strong>poistaa pysyv√§sti</strong> k√§ytt√§j√§n <strong>${username}</strong> ja kaikki h√§nen tietonsa? Toimintoa ei voi perua.`;
        document.getElementById('confirmDeleteForm').action = `/admin/delete_user/${userId}`;
        confirmDeleteModal.show();
        return;
    }

    // 2. K√§sittele muut toiminnot yksinkertaisella selaimen varmistuksella
    let message = '';
    let formAction = '';

    if (action === 'toggle') {
        const statusText = document.querySelector(`#user-row-${userId} .badge.bg-success`) ? 'est√§√§' : 'sallia';
        message = `Haluatko varmasti ${statusText} k√§ytt√§j√§n ${username}?`;
        formAction = `/admin/toggle_user/${userId}`;
    } else if (action === 'role') {
        const roleText = document.querySelector(`#user-row-${userId} .badge.bg-primary`) ? 'poistaa admin-oikeudet' : 'tehd√§ adminiksi';
        message = `Haluatko varmasti ${roleText} k√§ytt√§j√§lt√§ ${username}?`;
        formAction = `/admin/toggle_role/${userId}`;
    }

    if (message && confirm(message)) {
        // Luo ja l√§het√§ lomake taustalla
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = formAction;
        
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = '{{ csrf_token() }}';
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}