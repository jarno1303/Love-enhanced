{% extends "base.html" %}

{% block title %}Kehityskohteet - LOVe Enhanced{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-chart-line me-2 text-warning"></i>Kehityskohteet</h1>
        <a href="{{ url_for('dashboard_route') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Takaisin
        </a>
    </div>

    <div id="loading-spinner" class="text-center my-5">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-3 text-muted">Ladataan kehityskohteita...</p>
    </div>

    <div id="empty-state" class="text-center py-5" style="display: none;">
        <div class="card shadow-lg border-0 p-5">
            <div class="card-body">
                <i class="fas fa-check-circle fa-5x text-success mb-4"></i>
                <h2 class="mb-3">Hienoa työtä!</h2>
                <p class="lead text-muted mb-4">Sinulla ei ole kerrattavia kehityskohteita tällä hetkellä.</p>
                <a href="{{ url_for('practice_route') }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-play-circle me-2"></i>Aloita uusi harjoitus
                </a>
            </div>
        </div>
    </div>

    <div id="content" style="display: none;">
        <div class="card shadow-sm mb-4">
            <div class="card-body p-4">
                <div class="row align-items-center">
                    <div class="col-md-4 text-center border-end">
                        <h3 class="display-4 mb-0" id="total-mistakes">0</h3>
                        <p class="text-muted mb-0">Kehityskohdetta</p>
                    </div>
                    <div class="col-md-8">
                        <h5>Hallitse listaa</h5>
                        <p class="text-muted small">Valitse kysymyksiä ja päätä, mitä teet niille.</p>
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-success" id="review-selected-btn" disabled>
                                <i class="fas fa-redo me-2"></i>Kertaa valitut (0)
                            </button>
                            <button class="btn btn-outline-secondary" id="acknowledge-selected-btn" disabled>
                                <i class="fas fa-check me-2"></i>Kuittaa valitut (0)
                            </button>
                            <button class="btn btn-outline-danger" id="reset-all-btn">
                                <i class="fas fa-trash-alt me-2"></i>Nollaa kaikki
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Kysymykset, joita kannattaa kerrata</h5>
                <div id="category-filters" class="d-flex flex-wrap gap-2"></div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 5%;" class="text-center">
                                    <input type="checkbox" id="select-all-checkbox" title="Valitse kaikki">
                                </th>
                                <th style="width: 45%;">Kysymys</th>
                                <th style="width: 15%;">Kategoria</th>
                                <th style="width: 10%;" class="text-center">Onnistuminen</th>
                                <th style="width: 15%;" class="text-center">Tilasto</th>
                                <th style="width: 10%;">Toiminnot</th>
                            </tr>
                        </thead>
                        <tbody id="questions-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="explanationModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-lightbulb me-2"></i>Selitys</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6 class="mb-3" id="modal-question"></h6>
                <div id="modal-explanation"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Sulje</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="resetAllModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Vahvista nollaus</h5>
            </div>
            <div class="modal-body">
                <p><strong>VAROITUS:</strong> Olet aikeissa tyhjentää kaikki kehityskohteesi. Tämä piilottaa kaikki listalla olevat kysymykset.</p>
                <p>Toimintoa ei voi perua. Vahvistaaksesi kirjoita alla olevaan kenttään: <strong class="text-danger">OLEN VARMA</strong></p>
                <input type="text" id="reset-confirm-input" class="form-control" autocomplete="off">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Peruuta</button>
                <button type="button" class="btn btn-danger" id="reset-confirm-btn" disabled>Vahvista ja nollaa</button>
            </div>
        </div>
    </div>
</div>

<script>
let incorrectQuestions = [];
let explanationModal = null;
let resetAllModal = null;
const csrfToken = '{{ csrf_token() }}';

document.addEventListener('DOMContentLoaded', function() {
    explanationModal = new bootstrap.Modal(document.getElementById('explanationModal'));
    resetAllModal = new bootstrap.Modal(document.getElementById('resetAllModal'));
    
    document.getElementById('select-all-checkbox').addEventListener('change', toggleSelectAll);
    document.getElementById('review-selected-btn').addEventListener('click', startReview);
    document.getElementById('acknowledge-selected-btn').addEventListener('click', acknowledgeSelected);
    document.getElementById('reset-all-btn').addEventListener('click', () => resetAllModal.show());
    document.getElementById('reset-confirm-input').addEventListener('input', validateResetConfirmation);
    document.getElementById('reset-confirm-btn').addEventListener('click', executeResetAll);

    loadIncorrectQuestions();
});

async function loadIncorrectQuestions() {
    try {
        const response = await fetch('/api/incorrect_questions');
        const data = await response.json();
        
        if (data.questions.length === 0) {
            document.getElementById('loading-spinner').style.display = 'none';
            document.getElementById('empty-state').style.display = 'block';
            return;
        }
        
        incorrectQuestions = data.questions;
        displayQuestions();
        
        document.getElementById('loading-spinner').style.display = 'none';
        document.getElementById('content').style.display = 'block';
        
    } catch (error) {
        console.error('Virhe kysymysten lataamisessa:', error);
        document.getElementById('loading-spinner').innerHTML = `<div class="alert alert-danger">Virhe ladattaessa. <a href="javascript:location.reload()">Yritä uudelleen</a></div>`;
    }
}

function displayQuestions() {
    const tbody = document.getElementById('questions-tbody');
    tbody.innerHTML = '';
    
    document.getElementById('total-mistakes').textContent = incorrectQuestions.length;
    
    incorrectQuestions.forEach((q, index) => {
        const row = document.createElement('tr');
        row.id = `question-row-${q.id}`;
        
        const successRate = parseFloat(q.success_rate) || 0;
        let badgeClass = successRate >= 50 ? 'warning' : 'danger';
        
        row.innerHTML = `
            <td class="text-center align-middle">
                <input type="checkbox" class="form-check-input question-checkbox" data-question-id="${q.id}" onchange="updateButtonStates()">
            </td>
            <td class="align-middle">
                <div class="fw-bold">${q.question}</div>
            </td>
            <td class="align-middle">
                <span class="badge bg-primary">${q.category || 'Ei kategoriaa'}</span>
            </td>
            <td class="text-center align-middle">
                <span class="badge bg-${badgeClass} fs-6">${Math.round(successRate)}%</span>
            </td>
            <td class="text-center align-middle">
                <small class="text-muted">
                    ${parseInt(q.times_correct) || 0}/${parseInt(q.times_shown) || 0} oikein
                </small>
            </td>
            <td class="text-center align-middle">
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-info" onclick="showExplanation(${index})" title="Näytä selitys"><i class="fas fa-info-circle"></i></button>
                    <button class="btn btn-outline-secondary" onclick="acknowledgeSingle(${q.id})" title="Kuittaa tämä kysymys"><i class="fas fa-check"></i></button>
                </div>
            </td>
        `;
        
        tbody.appendChild(row);
    });
    
    updateButtonStates();
}

function updateButtonStates() {
    const selectedCount = document.querySelectorAll('.question-checkbox:checked').length;
    const reviewBtn = document.getElementById('review-selected-btn');
    const acknowledgeBtn = document.getElementById('acknowledge-selected-btn');
    
    reviewBtn.textContent = `Kertaa valitut (${selectedCount})`;
    acknowledgeBtn.textContent = `Kuittaa valitut (${selectedCount})`;
    
    reviewBtn.disabled = selectedCount === 0;
    acknowledgeBtn.disabled = selectedCount === 0;
    
    const allCheckboxes = document.querySelectorAll('.question-checkbox');
    document.getElementById('select-all-checkbox').checked = allCheckboxes.length > 0 && selectedCount === allCheckboxes.length;
}

function toggleSelectAll(event) {
    const isChecked = event.target.checked;
    document.querySelectorAll('.question-checkbox').forEach(cb => cb.checked = isChecked);
    updateButtonStates();
}

function showExplanation(index) {
    const q = incorrectQuestions[index];
    document.getElementById('modal-question').textContent = q.question;
    document.getElementById('modal-explanation').innerHTML = `<div class="alert alert-light">${q.explanation || 'Ei selitystä.'}</div>`;
    explanationModal.show();
}

async function acknowledgeMistakesOnServer(questionIds) {
    try {
        const response = await fetch('/api/mistakes/acknowledge', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ question_ids: questionIds })
        });
        if (!response.ok) throw new Error('Palvelinvirhe');
        return await response.json();
    } catch (error) {
        console.error("Virhe kuittauksessa:", error);
        alert("Kuittaus epäonnistui. Yritä myöhemmin uudelleen.");
        return { success: false };
    }
}

async function acknowledgeSingle(questionId) {
    if (!confirm("Haluatko varmasti kuitata tämän kysymyksen pois listalta?")) return;
    
    const result = await acknowledgeMistakesOnServer([questionId]);
    if (result.success) {
        document.getElementById(`question-row-${questionId}`).remove();
        incorrectQuestions = incorrectQuestions.filter(q => q.id !== questionId);
        updateButtonStates();
        document.getElementById('total-mistakes').textContent = incorrectQuestions.length;
        if (incorrectQuestions.length === 0) showEmptyState();
    }
}

async function acknowledgeSelected() {
    const selectedCheckboxes = document.querySelectorAll('.question-checkbox:checked');
    const questionIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.questionId));
    
    if (questionIds.length === 0) return;
    if (!confirm(`Haluatko varmasti kuitata ${questionIds.length} valittua kysymystä?`)) return;

    const result = await acknowledgeMistakesOnServer(questionIds);
    if (result.success) {
        questionIds.forEach(id => document.getElementById(`question-row-${id}`).remove());
        incorrectQuestions = incorrectQuestions.filter(q => !questionIds.includes(q.id));
        updateButtonStates();
        document.getElementById('total-mistakes').textContent = incorrectQuestions.length;
        if (incorrectQuestions.length === 0) showEmptyState();
    }
}

function validateResetConfirmation() {
    const input = document.getElementById('reset-confirm-input').value;
    document.getElementById('reset-confirm-btn').disabled = input !== 'OLEN VARMA';
}

async function executeResetAll() {
    const allQuestionIds = incorrectQuestions.map(q => q.id);
    if (allQuestionIds.length === 0) return;
    
    const result = await acknowledgeMistakesOnServer(allQuestionIds);
    if (result.success) {
        resetAllModal.hide();
        document.getElementById('questions-tbody').innerHTML = '';
        incorrectQuestions = [];
        showEmptyState();
    }
}

function startReview() {
    const selectedCheckboxes = document.querySelectorAll('.question-checkbox:checked');
    if (selectedCheckboxes.length === 0) {
        alert("Valitse ensin kysymyksiä, joita haluat kerrata.");
        return;
    }
    
    const questionsToReview = Array.from(selectedCheckboxes).map(cb => {
        return incorrectQuestions.find(q => q.id == cb.dataset.questionId);
    });
    
    const categories = [...new Set(questionsToReview.map(q => q.category).filter(c => c))];
    const params = new URLSearchParams();
    categories.forEach(cat => params.append('categories', cat));
    params.append('count', questionsToReview.length);
    params.append('source', 'mistakes');
    
    window.location.href = '/practice?' + params.toString();
}
</script>

<style>
    .question-checkbox { cursor: pointer; transform: scale(1.3); }
    #select-all-checkbox { cursor: pointer; transform: scale(1.3); }
    .table-hover tbody tr:hover { background-color: #f8f9fa; }
    .table thead th { position: sticky; top: 0; background-color: #f8f9fa; z-index: 10; }
</style>
{% endblock %}