{% extends "base.html" %}

{% block title %}Kehityskohteet - LOVe Enhanced{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-chart-line me-2 text-warning"></i>Kehityskohteet</h1>
        <a href="{{ url_for('dashboard_route') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Takaisin
        </a>
    </div>

    <div id="loading-spinner" class="text-center my-5">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-3 text-muted">Ladataan kehityskohteita...</p>
    </div>

    <div id="empty-state" class="text-center py-5" style="display: none;">
        <div class="card shadow-lg border-0 p-5">
            <div class="card-body">
                <i class="fas fa-check-circle fa-5x text-success mb-4"></i>
                <h2 class="mb-3">Hienoa ty√∂t√§!</h2>
                <p class="lead text-muted mb-4">Sinulla ei ole kerrattavia kehityskohteita t√§ll√§ hetkell√§.</p>
                <a href="{{ url_for('practice_route') }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-play-circle me-2"></i>Aloita uusi harjoitus
                </a>
            </div>
        </div>
    </div>

    <div id="content" style="display: none;">
        <div class="card shadow-sm mb-4">
            <div class="card-body p-4">
                <div class="row align-items-center">
                    <div class="col-md-4 text-center border-end">
                        <h3 class="display-4 mb-0" id="total-mistakes">0</h3>
                        <p class="text-muted mb-0">Kehityskohdetta</p>
                    </div>
                    <div class="col-md-8">
                        <h5>Hallitse listaa</h5>
                        <p class="text-muted small">Valitse kysymyksi√§ ja p√§√§t√§, mit√§ teet niille.</p>
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-success" id="review-selected-btn" disabled>
                                <i class="fas fa-redo me-2"></i>Kertaa valitut (0)
                            </button>
                            <button class="btn btn-outline-secondary" id="acknowledge-selected-btn" disabled>
                                <i class="fas fa-check me-2"></i>Kuittaa valitut (0)
                            </button>
                            <button class="btn btn-outline-danger" id="reset-all-btn">
                                <i class="fas fa-trash-alt me-2"></i>Nollaa kaikki
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-light p-3">
                <div class="row g-2 align-items-center">
                    <div class="col-lg-4">
                        <input type="text" id="search-input" class="form-control" placeholder="üîç Etsi kysymyksist√§...">
                    </div>
                    <div class="col-lg-8">
                        <div id="category-filters" class="d-flex flex-wrap gap-2"></div>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 5%;" class="text-center">
                                    <input type="checkbox" id="select-all-checkbox" title="Valitse kaikki n√§kyv√§t">
                                </th>
                                <th style="width: 45%; cursor: pointer;" data-sort="question">Kysymys <i class="fas fa-sort"></i></th>
                                <th style="width: 15%; cursor: pointer;" data-sort="category">Kategoria <i class="fas fa-sort"></i></th>
                                <th style="width: 10%; cursor: pointer;" class="text-center" data-sort="success_rate">Onnistuminen <i class="fas fa-sort"></i></th>
                                <th style="width: 15%; cursor: pointer;" class="text-center" data-sort="times_shown">Tilasto <i class="fas fa-sort"></i></th>
                                <th style="width: 10%;">Toiminnot</th>
                            </tr>
                        </thead>
                        <tbody id="questions-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="explanationModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-lightbulb me-2"></i>Selitys</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6 class="mb-3" id="modal-question"></h6>
                <div id="modal-explanation"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Sulje</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="resetAllModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Vahvista nollaus</h5>
            </div>
            <div class="modal-body">
                <p><strong>VAROITUS:</strong> Olet aikeissa tyhjent√§√§ kaikki kehityskohteesi. T√§m√§ piilottaa kaikki listalla olevat kysymykset.</p>
                <p>Toimintoa ei voi perua. Vahvistaaksesi kirjoita alla olevaan kentt√§√§n: <strong class="text-danger">OLEN VARMA</strong></p>
                <input type="text" id="reset-confirm-input" class="form-control" autocomplete="off">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Peruuta</button>
                <button type="button" class="btn btn-danger" id="reset-confirm-btn" disabled>Vahvista ja nollaa</button>
            </div>
        </div>
    </div>
</div>

<script>
let allIncorrectQuestions = [];
let explanationModal = null;
let resetAllModal = null;
const csrfToken = '{{ csrf_token() }}';

// UUDET MUUTTUJAT lajittelua ja suodatusta varten
let currentSort = { column: 'success_rate', direction: 'asc' };
let currentSearch = '';
let currentCategoryFilter = 'all';

document.addEventListener('DOMContentLoaded', function() {
    explanationModal = new bootstrap.Modal(document.getElementById('explanationModal'));
    resetAllModal = new bootstrap.Modal(document.getElementById('resetAllModal'));
    
    document.getElementById('select-all-checkbox').addEventListener('change', toggleSelectAll);
    document.getElementById('review-selected-btn').addEventListener('click', startReview);
    document.getElementById('acknowledge-selected-btn').addEventListener('click', acknowledgeSelected);
    document.getElementById('reset-all-btn').addEventListener('click', () => resetAllModal.show());
    document.getElementById('reset-confirm-input').addEventListener('input', validateResetConfirmation);
    document.getElementById('reset-confirm-btn').addEventListener('click', executeResetAll);
    document.getElementById('search-input').addEventListener('keyup', handleSearch);
    
    document.querySelectorAll('th[data-sort]').forEach(header => {
        header.addEventListener('click', () => sortTable(header.dataset.sort));
    });

    loadIncorrectQuestions();
});

async function loadIncorrectQuestions() {
    try {
        const response = await fetch('/api/incorrect_questions');
        const data = await response.json();
        
        if (data.questions.length === 0) {
            document.getElementById('loading-spinner').style.display = 'none';
            document.getElementById('empty-state').style.display = 'block';
            return;
        }
        
        allIncorrectQuestions = data.questions;
        document.getElementById('total-mistakes').textContent = allIncorrectQuestions.length;
        createCategoryFilters();
        displayQuestions();
        
        document.getElementById('loading-spinner').style.display = 'none';
        document.getElementById('content').style.display = 'block';
        
    } catch (error) {
        console.error('Virhe kysymysten lataamisessa:', error);
        document.getElementById('loading-spinner').innerHTML = `<div class="alert alert-danger">Virhe ladattaessa. <a href="javascript:location.reload()">Yrit√§ uudelleen</a></div>`;
    }
}

// P√ÑIVITETTY displayQuestions-funktio: suodattaa, lajittelee ja n√§ytt√§√§ datan
function displayQuestions() {
    const tbody = document.getElementById('questions-tbody');
    tbody.innerHTML = '';
    
    // 1. Suodata (Filter)
    let filteredQuestions = allIncorrectQuestions.filter(q => {
        const matchesCategory = currentCategoryFilter === 'all' || q.category === currentCategoryFilter;
        const matchesSearch = currentSearch === '' || q.question.toLowerCase().includes(currentSearch);
        return matchesCategory && matchesSearch;
    });

    // 2. Lajittele (Sort)
    filteredQuestions.sort((a, b) => {
        const valA = a[currentSort.column];
        const valB = b[currentSort.column];
        let comparison = 0;
        if (valA > valB) {
            comparison = 1;
        } else if (valA < valB) {
            comparison = -1;
        }
        return currentSort.direction === 'desc' ? comparison * -1 : comparison;
    });
    
    // 3. N√§yt√§ (Render)
    filteredQuestions.forEach(q => {
        const row = document.createElement('tr');
        row.id = `question-row-${q.id}`;
        
        const successRate = parseFloat(q.success_rate) || 0;
        let badgeClass = successRate >= 50 ? 'warning' : 'danger';
        
        row.innerHTML = `
            <td class="text-center align-middle"><input type="checkbox" class="form-check-input question-checkbox" data-question-id="${q.id}" onchange="updateButtonStates()"></td>
            <td class="align-middle"><div class="fw-bold">${q.question}</div></td>
            <td class="align-middle"><span class="badge bg-primary">${q.category || 'Ei kategoriaa'}</span></td>
            <td class="text-center align-middle"><span class="badge bg-${badgeClass} fs-6">${Math.round(successRate)}%</span></td>
            <td class="text-center align-middle"><small class="text-muted">${parseInt(q.times_correct) || 0}/${parseInt(q.times_shown) || 0} oikein</small></td>
            <td class="text-center align-middle">
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-info" onclick='showExplanationById(${q.id})' title="N√§yt√§ selitys"><i class="fas fa-info-circle"></i></button>
                    <button class="btn btn-outline-secondary" onclick="acknowledgeSingle(${q.id})" title="Kuittaa t√§m√§ kysymys"><i class="fas fa-check"></i></button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });

    updateButtonStates();
    updateSortIcons();
}

// UUSI: Lajittelufunktio
function sortTable(column) {
    if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
    }
    displayQuestions();
}

function updateSortIcons() {
    document.querySelectorAll('th[data-sort]').forEach(header => {
        const icon = header.querySelector('i');
        icon.className = 'fas fa-sort';
        if (header.dataset.sort === currentSort.column) {
            icon.className = currentSort.direction === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
        }
    });
}

// UUSI: Hakukent√§n logiikka
function handleSearch(event) {
    currentSearch = event.target.value.toLowerCase();
    displayQuestions();
}

// MUOKATTU: Kategoriapainikkeet toimivat nyt suodattimina
function createCategoryFilters() {
    const categoryCounts = allIncorrectQuestions.reduce((acc, q) => {
        acc[q.category] = (acc[q.category] || 0) + 1;
        return acc;
    }, {});
    
    const filterContainer = document.getElementById('category-filters');
    filterContainer.innerHTML = `<button class="btn btn-sm btn-light active" data-category="all">Kaikki (${allIncorrectQuestions.length})</button>`;
    
    Object.entries(categoryCounts).sort().forEach(([category, count]) => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-sm btn-outline-light';
        btn.dataset.category = category;
        btn.textContent = `${category} (${count})`;
        filterContainer.appendChild(btn);
    });
    
    filterContainer.addEventListener('click', (event) => {
        if (event.target.tagName === 'BUTTON') {
            filterContainer.querySelector('.active').classList.remove('active', 'btn-light');
            filterContainer.querySelector('.active')?.classList.add('btn-outline-light');
            event.target.classList.add('active', 'btn-light');
            event.target.classList.remove('btn-outline-light');
            
            currentCategoryFilter = event.target.dataset.category;
            displayQuestions();
        }
    });
}

function updateButtonStates() {
    const selectedCount = document.querySelectorAll('.question-checkbox:checked').length;
    const reviewBtn = document.getElementById('review-selected-btn');
    const acknowledgeBtn = document.getElementById('acknowledge-selected-btn');
    
    reviewBtn.textContent = `Kertaa valitut (${selectedCount})`;
    acknowledgeBtn.textContent = `Kuittaa valitut (${selectedCount})`;
    
    reviewBtn.disabled = selectedCount === 0;
    acknowledgeBtn.disabled = selectedCount === 0;
    
    const allVisibleCheckboxes = document.querySelectorAll('#questions-tbody .question-checkbox');
    document.getElementById('select-all-checkbox').checked = allVisibleCheckboxes.length > 0 && selectedCount === allVisibleCheckboxes.length;
}

function toggleSelectAll(event) {
    const isChecked = event.target.checked;
    document.querySelectorAll('#questions-tbody .question-checkbox').forEach(cb => cb.checked = isChecked);
    updateButtonStates();
}

function showExplanationById(questionId) {
    const q = allIncorrectQuestions.find(q => q.id === questionId);
    if (q) {
        document.getElementById('modal-question').textContent = q.question;
        document.getElementById('modal-explanation').innerHTML = `<div class="alert alert-light">${q.explanation || 'Ei selityst√§.'}</div>`;
        explanationModal.show();
    }
}

async function acknowledgeMistakesOnServer(questionIds) {
    try {
        const response = await fetch('/api/mistakes/acknowledge', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ question_ids: questionIds })
        });
        if (!response.ok) throw new Error('Palvelinvirhe');
        return await response.json();
    } catch (error) {
        console.error("Virhe kuittauksessa:", error);
        alert("Kuittaus ep√§onnistui. Yrit√§ my√∂hemmin uudelleen.");
        return { success: false };
    }
}

async function acknowledgeSingle(questionId) {
    if (!confirm("Haluatko varmasti kuitata t√§m√§n kysymyksen pois listalta?")) return;
    
    const result = await acknowledgeMistakesOnServer([questionId]);
    if (result.success) {
        allIncorrectQuestions = allIncorrectQuestions.filter(q => q.id !== questionId);
        document.getElementById('total-mistakes').textContent = allIncorrectQuestions.length;
        if (allIncorrectQuestions.length === 0) {
            showEmptyState();
        } else {
            displayQuestions();
        }
    }
}

async function acknowledgeSelected() {
    const selectedCheckboxes = document.querySelectorAll('.question-checkbox:checked');
    const questionIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.questionId));
    
    if (questionIds.length === 0) return;
    if (!confirm(`Haluatko varmasti kuitata ${questionIds.length} valittua kysymyst√§?`)) return;

    const result = await acknowledgeMistakesOnServer(questionIds);
    if (result.success) {
        allIncorrectQuestions = allIncorrectQuestions.filter(q => !questionIds.includes(q.id));
        document.getElementById('total-mistakes').textContent = allIncorrectQuestions.length;
        if (allIncorrectQuestions.length === 0) {
            showEmptyState();
        } else {
            displayQuestions();
        }
    }
}

function validateResetConfirmation() {
    const input = document.getElementById('reset-confirm-input').value;
    document.getElementById('reset-confirm-btn').disabled = input !== 'OLEN VARMA';
}

async function executeResetAll() {
    const allQuestionIds = allIncorrectQuestions.map(q => q.id);
    if (allQuestionIds.length === 0) return;
    
    const result = await acknowledgeMistakesOnServer(allQuestionIds);
    if (result.success) {
        resetAllModal.hide();
        allIncorrectQuestions = [];
        showEmptyState();
    }
}

function startReview() {
    const selectedCheckboxes = document.querySelectorAll('.question-checkbox:checked');
    if (selectedCheckboxes.length === 0) {
        alert("Valitse ensin kysymyksi√§, joita haluat kerrata.");
        return;
    }
    
    const questionsToReview = Array.from(selectedCheckboxes).map(cb => {
        return allIncorrectQuestions.find(q => q.id == cb.dataset.questionId);
    });
    
    const categories = [...new Set(questionsToReview.map(q => q.category).filter(c => c))];
    const params = new URLSearchParams();
    categories.forEach(cat => params.append('categories', cat));
    params.append('count', questionsToReview.length);
    params.append('source', 'mistakes');
    
    window.location.href = '/practice?' + params.toString();
}
</script>

<style>
    .question-checkbox, #select-all-checkbox { cursor: pointer; transform: scale(1.3); }
    .table-hover tbody tr:hover { background-color: #f8f9fa; }
    .table thead th { position: sticky; top: 0; background-color: #f8f9fa; z-index: 10; }
    th[data-sort] i { margin-left: 5px; color: #aaa; }
    th[data-sort]:hover i { color: #333; }
</style>
{% endblock %}